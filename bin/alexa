#!/usr/bin/env php
<?php

declare(strict_types=1);

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * Alexa CLI Generator
 * 
 * This command-line tool helps generate skeleton files for Alexa skill development.
 * 
 * Usage:
 * php bin/alexa make:intent-handler MyIntentHandler --intent=MyIntent
 * php bin/alexa make:launch-handler LaunchHandler
 * php bin/alexa make:help-handler HelpHandler
 */

class AlexaCli
{
    private string $templatesPath;
    private string $outputPath;

    public function __construct()
    {
        $this->templatesPath = __DIR__ . '/../templates';
        $this->outputPath = getcwd() . '/src/Handlers';
    }

    public function run(array $argv): void
    {
        if (empty($argv[1])) {
            $this->showHelp();
            return;
        }

        $command = $argv[1];
        $args = array_slice($argv, 2);

        switch ($command) {
            case 'make:intent-handler':
                $this->makeIntentHandler($args);
                break;
            case 'make:launch-handler':
                $this->makeLaunchHandler($args);
                break;
            case 'make:help-handler':
                $this->makeHelpHandler($args);
                break;
            case 'generate:interaction-model':
                $this->generateInteractionModel($args);
                break;
            case 'list':
                $this->listTemplates();
                break;
            default:
                $this->error("Unknown command: {$command}");
                $this->showHelp();
        }
    }

    private function makeIntentHandler(array $args): void
    {
        $options = $this->parseArgs($args);
        $interactive = in_array('--interactive', $args) || in_array('-i', $args);
        
        if ($interactive) {
            $this->interactiveIntentHandler();
            return;
        }

        $className = $options['name'] ?? null;
        $intentName = $options['intent'] ?? null;

        if (!$className || !$intentName) {
            $this->error('Both --name and --intent are required');
            return;
        }

        $utterances = $options['utterances'] ?? [];
        if (is_string($utterances)) {
            $utterances = explode(',', $utterances);
        }

        $template = $this->getTemplate('intent-handler.php.template');
        $content = str_replace(
            ['{{NAMESPACE}}', '{{CLASS_NAME}}', '{{INTENT_NAME}}', '{{DESCRIPTION}}', '{{UTTERANCES}}'],
            [
                $options['namespace'] ?? 'App\\Handlers',
                $className,
                $intentName,
                'Handler for ' . $intentName,
                $this->formatUtterances($utterances)
            ],
            $template
        );

        $this->writeFile($className . '.php', $content);
        $this->success("Created intent handler: {$className}.php");
    }

    private function interactiveIntentHandler(): void
    {
        $this->info("ðŸš€ Interactive Intent Handler Generator\n");

        // Get class name
        $className = $this->ask("Handler class name (e.g., OrderPizzaHandler): ");
        if (empty($className)) {
            $this->error("Class name is required");
            return;
        }

        // Get intent name
        $intentName = $this->ask("Intent name (e.g., OrderPizzaIntent): ");
        if (empty($intentName)) {
            $this->error("Intent name is required");
            return;
        }

        // Get description
        $description = $this->ask("Description (optional): ", "Handler for {$intentName}");

        // Get utterances interactively
        $this->info("\nðŸ“ Sample Utterances (press Enter to finish):");
        $utterances = [];
        
        // Suggest some utterances
        require_once __DIR__ . '/../src/Generator/UtteranceExtractor.php';
        $extractor = new \Rboschin\AmazonAlexa\Generator\UtteranceExtractor();
        $suggestions = $extractor->suggestUtterances($intentName);
        
        if (!empty($suggestions)) {
            $this->info("Suggested utterances:");
            foreach ($suggestions as $i => $suggestion) {
                echo "  " . ($i + 1) . ". {$suggestion}\n";
            }
            
            $useSuggestions = $this->ask("Use these suggestions? (y/n): ", 'y');
            if (strtolower($useSuggestions) === 'y') {
                $utterances = $suggestions;
            }
        }

        if (empty($utterances) || strtolower($this->ask("Add custom utterances? (y/n): ", 'n')) === 'y') {
            do {
                $utterance = $this->ask("Enter utterance (or press Enter to finish): ");
                if (!empty($utterance)) {
                    $utterances[] = $utterance;
                }
            } while (!empty($utterance));
        }

        // Get slots
        $this->info("\nðŸŽ¯ Slots (press Enter to finish):");
        $slots = [];
        do {
            $slotName = $this->ask("Slot name (or press Enter to finish): ");
            if (!empty($slotName)) {
                $slotType = $this->ask("Slot type (e.g., AMAZON.NUMBER, AMAZON.DATE, custom): ", 'AMAZON.LITERAL');
                $slots[$slotName] = $slotType;
            }
        } while (!empty($slotName));

        // Generate the handler
        $template = $this->getTemplate('intent-handler.php.template');
        $content = str_replace([
            '{{CLASS_NAME}}' => $className,
            '{{INTENT_NAME}}' => $intentName,
            '{{DESCRIPTION}}' => $description,
            '{{UTTERANCES}}' => $this->formatUtterances($utterances),
            '{{SLOTS}}' => $this->formatSlots($slots)
        ], $template);

        $this->writeFile($className . '.php', $content);
        $this->success("âœ… Created intent handler: {$className}.php");

        // Show summary
        $this->info("\nðŸ“Š Summary:");
        $this->info("  Class: {$className}");
        $this->info("  Intent: {$intentName}");
        $this->info("  Utterances: " . count($utterances));
        $this->info("  Slots: " . count($slots));

        if (!empty($utterances)) {
            $this->info("\nðŸ“ Utterances added to docblock:");
            foreach ($utterances as $utterance) {
                $this->info("  - {$utterance}");
            }
        }
    }

    private function makeLaunchHandler(array $args): void
    {
        $options = $this->parseArgs($args);
        $className = $options['name'] ?? 'LaunchHandler';

        if (!$className) {
            $this->error('Handler class name is required');
            return;
        }

        $template = $this->getTemplate('launch-handler.php.template');
        $content = str_replace([
            '{{CLASS_NAME}}' => $className,
            '{{DESCRIPTION}}' => 'Handler for LaunchRequest'
        ], $template);

        $this->writeFile($className . '.php', $content);
        $this->success("Created launch handler: {$className}.php");
    }

    private function makeHelpHandler(array $args): void
    {
        $options = $this->parseArgs($args);
        $className = $options['name'] ?? 'HelpHandler';

        if (!$className) {
            $this->error('Handler class name is required');
            return;
        }

        $template = $this->getTemplate('help-handler.php.template');
        $content = str_replace([
            '{{CLASS_NAME}}' => $className,
            '{{DESCRIPTION}}' => 'Handler for Help/Cancel/Stop intents'
        ], $template);

        $this->writeFile($className . '.php', $content);
        $this->success("Created help handler: {$className}.php");
    }

    private function generateInteractionModel(array $args): void
    {
        // Parse arguments properly handling quoted strings
        $options = [];
        $currentKey = null;
        
        foreach ($args as $arg) {
            if (strpos($arg, '--') === 0 && strpos($arg, '=') !== false) {
                // Simple case: --option=value
                list($key, $value) = explode('=', $arg, 2);
                $currentKey = str_replace('--', '', $key);
                $options[$currentKey] = $value;
            } elseif (strpos($arg, '--') === 0) {
                // Complex case: --option "value with spaces"
                $currentKey = str_replace('--', '', $arg);
            } elseif ($currentKey !== null) {
                // Value for previous key
                $options[$currentKey] = trim($arg, '"\'');
                $currentKey = null;
            }
        }

        $skillName = $options['skill'] ?? 'MySkill';
        $invocationName = $options['invocation'] ?? 'my skill';
        $locale = $options['locale'] ?? 'en-US';
        $handlersDir = $options['handlers'] ?? 'src/Handlers';
        $namespace = $options['namespace'] ?? 'App\\Handlers';
        $output = $options['output'] ?? 'interaction-model.json';

        if (!is_dir($handlersDir)) {
            $this->error("Handlers directory not found: {$handlersDir}");
            return;
        }

        // Include framework autoloader first
        if (file_exists(__DIR__ . '/../vendor/autoload.php')) {
            require_once __DIR__ . '/../vendor/autoload.php';
        }

        // Include required files directly if autoloader fails
        require_once __DIR__ . '/../src/RequestHandler/AbstractRequestHandler.php';
        require_once __DIR__ . '/../src/Generator/InteractionModelGenerator.php';
        require_once __DIR__ . '/../src/Generator/UtteranceExtractor.php';

        $generator = new \Rboschin\AmazonAlexa\Generator\InteractionModelGenerator(
            $skillName,
            $invocationName,
            $locale
        );

        try {
            // Load handlers from directory
            $generator->loadHandlersFromDirectory($handlersDir, $namespace);
            
            // Analyze handlers
            $generator->analyze();

            // Get analysis results
            $intents = $generator->getIntents();
            $handlers = $generator->getHandlers();

            $this->info("Found " . count($handlers) . " handlers:");
            foreach ($handlers as $handler) {
                $this->info("  - {$handler}");
            }

            $this->info("Detected " . count($intents) . " intents:");
            foreach ($intents as $intentName => $intentData) {
                $this->info("  - {$intentName}");
                if (!empty($intentData['slots'])) {
                    foreach ($intentData['slots'] as $slot) {
                        $this->info("    Slot: {$slot['name']} ({$slot['type']})");
                    }
                }
            }

            // Generate and save interaction model
            $generator->saveToFile($output);
            $this->success("Interaction model generated: {$output}");

            // Show warning about potential limitations
            $this->info("\nâš ï¸  Note: This is an auto-generated interaction model.");
            $this->info("   You should review and enhance it with:");
            $this->info("   - More sample utterances");
            $this->info("   - Custom slot types");
            $this->info("   - Synonyms and variations");
            $this->info("   - Dialog management if needed");

        } catch (\Exception $e) {
            $this->error("Error generating interaction model: " . $e->getMessage());
        }
    }

    private function parseArgs(array $args): array
    {
        $options = [];
        
        foreach ($args as $arg) {
            if (strpos($arg, '--name=') === 0) {
                $options['name'] = substr($arg, 7);
            } elseif (strpos($arg, '--intent=') === 0) {
                $options['intent'] = substr($arg, 9);
            } elseif (strpos($arg, '--utterances=') === 0) {
                $options['utterances'] = substr($arg, 13);
            } elseif (strpos($arg, '--skill=') === 0) {
                $options['skill'] = substr($arg, 8);
            } elseif (strpos($arg, '--invocation=') === 0) {
                $options['invocation'] = substr($arg, 13);
            } elseif (strpos($arg, '--locale=') === 0) {
                $options['locale'] = substr($arg, 9);
            } elseif (strpos($arg, '--handlers=') === 0) {
                $options['handlers'] = substr($arg, 12);
            } elseif (strpos($arg, '--namespace=') === 0) {
                $options['namespace'] = substr($arg, 12);
            } elseif (strpos($arg, '--output=') === 0) {
                $options['output'] = substr($arg, 9);
            }
        }
        
        return $options;
    }

    private function getTemplate(string $filename): string
    {
        $templateFile = $this->templatesPath . '/' . $filename;
        
        if (!file_exists($templateFile)) {
            $this->error("Template not found: {$filename}");
            exit(1);
        }
        
        return file_get_contents($templateFile);
    }

    private function writeFile(string $filename, string $content): void
    {
        if (!is_dir($this->outputPath)) {
            mkdir($this->outputPath, 0755, true);
        }

        $filePath = $this->outputPath . '/' . $filename;
        
        if (file_exists($filePath)) {
            $this->error("File already exists: {$filename}");
            return;
        }

        if (file_put_contents($filePath, $content) === false) {
            $this->error("Failed to write file: {$filename}");
            return;
        }
    }

    private function listTemplates(): void
    {
        $this->info("Available templates:");
        
        $templates = [
            'intent-handler.php.template' => 'Generate intent handler',
            'launch-handler.php.template' => 'Generate launch handler',
            'help-handler.php.template' => 'Generate help handler',
        ];
        
        foreach ($templates as $file => $description) {
            echo "  {$file} - {$description}\n";
        }

        $this->info("\nAvailable commands:");
        echo "  make:intent-handler - Generate intent handler skeleton\n";
        echo "  make:launch-handler - Generate launch handler skeleton\n";
        echo "  make:help-handler - Generate help handler skeleton\n";
        echo "  generate:interaction-model - Generate Alexa interaction model from handlers\n";
    }

    private function showHelp(): void
    {
        echo "Alexa CLI Generator\n\n";
        echo "Usage:\n";
        echo "  php bin/alexa <command> [options]\n\n";
        echo "Commands:\n";
        echo "  make:intent-handler <name> --intent=<intent>    Generate intent handler\n";
        echo "  make:launch-handler <name>                Generate launch handler\n";
        echo "  make:help-handler <name>                  Generate help handler\n";
        echo "  generate:interaction-model                 Generate Alexa interaction model\n";
        echo "  list                                      List available templates\n\n";
        echo "Options:\n";
        echo "  --name=<ClassName>                        Handler class name\n";
        echo "  --intent=<IntentName>                      Intent name (for intent handlers)\n";
        echo "  --utterances=<utterance1,utterance2>       Sample utterances (comma-separated)\n";
        echo "  --interactive, -i                         Interactive mode with guided prompts\n";
        echo "  --skill=<SkillName>                        Skill name (for interaction model)\n";
        echo "  --invocation=<Name>                       Invocation name (for interaction model)\n";
        echo "  --locale=<Locale>                          Locale (default: en-US)\n";
        echo "  --handlers=<Directory>                     Handlers directory (default: src/Handlers)\n";
        echo "  --namespace=<Namespace>                     Handler namespace (default: App\\Handlers)\n";
        echo "  --output=<File>                          Output file (default: interaction-model.json)\n\n";
        echo "Examples:\n";
        echo "  php bin/alexa make:intent-handler MyIntent --intent=MyIntent\n";
        echo "  php bin/alexa make:intent-handler OrderPizza --intent=OrderPizzaIntent --utterances=\"order pizza, get me a pizza\"\n";
        echo "  php bin/alexa make:intent-handler -i --interactive\n";
        echo "  php bin/alexa make:launch-handler LaunchHandler\n";
        echo "  php bin/alexa make:help-handler HelpHandler\n";
        echo "  php bin/alexa generate:interaction-model --skill='My Skill' --invocation='my skill'\n\n";
        echo "Features:\n";
        echo "  @utterances tag support in docblocks\n";
        echo "  Interactive mode with guided prompts\n";
        echo "  Automatic utterance suggestions\n";
        echo "  Slot type inference\n";
        echo "  Complete interaction model generation\n";
    }

    private function success(string $message): void
    {
        echo "\033[32mâœ“\033[0m {$message}\n";
    }

    private function error(string $message): void
    {
        echo "\033[31mâœ—\033[0m {$message}\n";
    }

    private function ask(string $question, string $default = ''): string
    {
        if (!empty($default)) {
            echo "\033[36m? \033[0m{$question} [\033[33m{$default}\033[0m]: ";
        } else {
            echo "\033[36m? \033[0m{$question}: ";
        }
        
        $handle = fopen('php://stdin', 'r');
        if ($handle === false) {
            return $default;
        }
        
        $answer = fgets($handle);
        if ($answer === false) {
            fclose($handle);
            return $default;
        }
        
        fclose($handle);
        $answer = trim($answer);
        
        return empty($answer) ? $default : $answer;
    }

    private function formatUtterances(array $utterances): string
    {
        if (empty($utterances)) {
            return '';
        }

        $lines = [' * @utterances ' . implode(', ', $utterances)];
        return implode("\n", $lines);
    }

    private function formatSlots(array $slots): string
    {
        if (empty($slots)) {
            return '';
        }

        $lines = [' * @slots'];
        foreach ($slots as $name => $type) {
            $lines[] = " *   {$name}: {$type}";
        }
        
        return implode("\n", $lines);
    }

    private function info(string $message): void
    {
        echo "\033[34mâ„¹\033[0m {$message}\n";
    }
}

// Create templates directory if it doesn't exist
$templatesDir = __DIR__ . '/../templates';
if (!is_dir($templatesDir)) {
    mkdir($templatesDir, 0755, true);
}

// Create template files if they don't exist
$intentTemplate = <<<PHP
<?php

declare(strict_types=1);

namespace App\Handlers;

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Request\Request;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * {{DESCRIPTION}}
 */
class {{CLASS_NAME}} extends AbstractRequestHandler
{
    public function supportsApplication(Request \$request): bool
    {
        return true; // Add your skill ID check here
    }

    public function supportsRequest(Request \$request): bool
    {
        return \$request->request instanceof \Rboschin\AmazonAlexa\Request\Request\Standard\IntentRequest &&
               \$request->request->intent->name === '{{INTENT_NAME}}';
    }

    public function handleRequest(Request \$request): \Rboschin\AmazonAlexa\Response\Response
    {
        \$slotValue = \$request->request->intent->slots['exampleSlot']->value ?? null;
        
        return ResponseBuilder::create()
            ->text("You triggered {{INTENT_NAME}} with slot value: {\$slotValue}")
            ->reprompt("What else would you like to do?")
            ->keepSession()
            ->build();
    }
}
PHP;

$launchTemplate = <<<PHP
<?php

declare(strict_types=1);

namespace App\Handlers;

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Request\Request;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * {{DESCRIPTION}}
 */
class {{CLASS_NAME}} extends AbstractRequestHandler
{
    public function supportsApplication(Request \$request): bool
    {
        return true; // Add your skill ID check here
    }

    public function supportsRequest(Request \$request): bool
    {
        return \$request->request instanceof \Rboschin\AmazonAlexa\Request\Request\Standard\LaunchRequest;
    }

    public function handleRequest(Request \$request): \Rboschin\AmazonAlexa\Response\Response
    {
        return ResponseBuilder::create()
            ->text('Welcome to the skill!')
            ->reprompt('How can I help you today?')
            ->keepSession()
            ->build();
    }
}
PHP;

$helpTemplate = <<<PHP
<?php

declare(strict_types=1);

namespace App\Handlers;

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Request\Request;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * {{DESCRIPTION}}
 */
class {{CLASS_NAME}} extends AbstractRequestHandler
{
    public function supportsApplication(Request \$request): bool
    {
        return true; // Add your skill ID check here
    }

    public function supportsRequest(Request \$request): bool
    {
        return \$request->request instanceof \Rboschin\AmazonAlexa\Request\Request\Standard\IntentRequest &&
               in_array(\$request->request->intent->name, [
                   'AMAZON.HelpIntent',
                   'AMAZON.CancelIntent',
                   'AMAZON.StopIntent'
               ]);
    }

    public function handleRequest(Request \$request): \Rboschin\AmazonAlexa\Response\Response
    {
        \$intentName = \$request->request->intent->name;
        
        switch (\$intentName) {
            case 'AMAZON.HelpIntent':
                return ResponseBuilder::create()
                    ->text('You can ask me to do various things. What would you like to know?')
                    ->reprompt('How can I help you?')
                    ->keepSession()
                    ->build();
            
            case 'AMAZON.CancelIntent':
            case 'AMAZON.StopIntent':
                return ResponseBuilder::create()
                    ->text('Goodbye!')
                    ->endSession(true)
                    ->build();
            
            default:
                return ResponseBuilder::create()
                    ->text('I can help you with that. What would you like to do?')
                    ->reprompt('How can I assist you?')
                    ->keepSession()
                    ->build();
        }
    }
}
PHP;

file_put_contents($templatesDir . '/intent-handler.php.template', $intentTemplate);
file_put_contents($templatesDir . '/launch-handler.php.template', $launchTemplate);
file_put_contents($templatesDir . '/help-handler.php.template', $helpTemplate);

// Run the CLI
$cli = new AlexaCli();
$cli->run($argv);
?>
