#!/usr/bin/env php
<?php

declare(strict_types=1);

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * Alexa CLI Generator
 * 
 * This command-line tool helps generate skeleton files for Alexa skill development.
 * 
 * Usage:
 * php bin/alexa make:intent-handler MyIntentHandler --intent=MyIntent
 * php bin/alexa make:launch-handler LaunchHandler
 * php bin/alexa make:help-handler HelpHandler
 */

class AlexaCli
{
    private string $templatesPath;
    private string $outputPath;

    public function __construct()
    {
        $this->templatesPath = __DIR__ . '/../templates';
        $this->outputPath = getcwd() . '/src/Handlers';
    }

    public function run(array $argv): void
    {
        if (empty($argv[1])) {
            $this->showHelp();
            return;
        }

        $command = $argv[1];
        $args = array_slice($argv, 2);

        switch ($command) {
            case 'make:intent-handler':
                $this->makeIntentHandler($args);
                break;
            case 'make:launch-handler':
                $this->makeLaunchHandler($args);
                break;
            case 'make:help-handler':
                $this->makeHelpHandler($args);
                break;
            case 'list':
                $this->listTemplates();
                break;
            default:
                $this->error("Unknown command: {$command}");
                $this->showHelp();
        }
    }

    private function makeIntentHandler(array $args): void
    {
        $options = $this->parseArgs($args);
        $className = $options['name'] ?? 'MyIntentHandler';
        $intentName = $options['intent'] ?? 'MyIntent';

        if (!$className) {
            $this->error('Handler class name is required');
            return;
        }

        $template = $this->getTemplate('intent-handler.php.template');
        $content = str_replace([
            '{{CLASS_NAME}}' => $className,
            '{{INTENT_NAME}}' => $intentName,
            '{{DESCRIPTION}}' => "Handler for {$intentName} intent"
        ], $template);

        $this->writeFile($className . '.php', $content);
        $this->success("Created intent handler: {$className}.php");
    }

    private function makeLaunchHandler(array $args): void
    {
        $options = $this->parseArgs($args);
        $className = $options['name'] ?? 'LaunchHandler';

        if (!$className) {
            $this->error('Handler class name is required');
            return;
        }

        $template = $this->getTemplate('launch-handler.php.template');
        $content = str_replace([
            '{{CLASS_NAME}}' => $className,
            '{{DESCRIPTION}}' => 'Handler for LaunchRequest'
        ], $template);

        $this->writeFile($className . '.php', $content);
        $this->success("Created launch handler: {$className}.php");
    }

    private function makeHelpHandler(array $args): void
    {
        $options = $this->parseArgs($args);
        $className = $options['name'] ?? 'HelpHandler';

        if (!$className) {
            $this->error('Handler class name is required');
            return;
        }

        $template = $this->getTemplate('help-handler.php.template');
        $content = str_replace([
            '{{CLASS_NAME}}' => $className,
            '{{DESCRIPTION}}' => 'Handler for Help/Cancel/Stop intents'
        ], $template);

        $this->writeFile($className . '.php', $content);
        $this->success("Created help handler: {$className}.php");
    }

    private function parseArgs(array $args): array
    {
        $options = [];
        
        foreach ($args as $arg) {
            if (str_starts_with($arg, '--name=')) {
                $options['name'] = substr($arg, 7);
            } elseif (str_starts_with($arg, '--intent=')) {
                $options['intent'] = substr($arg, 9);
            }
        }
        
        return $options;
    }

    private function getTemplate(string $filename): string
    {
        $templateFile = $this->templatesPath . '/' . $filename;
        
        if (!file_exists($templateFile)) {
            $this->error("Template not found: {$filename}");
            exit(1);
        }
        
        return file_get_contents($templateFile);
    }

    private function writeFile(string $filename, string $content): void
    {
        if (!is_dir($this->outputPath)) {
            mkdir($this->outputPath, 0755, true);
        }

        $filePath = $this->outputPath . '/' . $filename;
        
        if (file_exists($filePath)) {
            $this->error("File already exists: {$filename}");
            return;
        }

        if (file_put_contents($filePath, $content) === false) {
            $this->error("Failed to write file: {$filename}");
            return;
        }
    }

    private function listTemplates(): void
    {
        $this->info("Available templates:");
        
        $templates = [
            'intent-handler.php.template' => 'Generate intent handler',
            'launch-handler.php.template' => 'Generate launch handler',
            'help-handler.php.template' => 'Generate help handler',
        ];
        
        foreach ($templates as $file => $description) {
            echo "  {$file} - {$description}\n";
        }
    }

    private function showHelp(): void
    {
        echo "Alexa CLI Generator\n\n";
        echo "Usage:\n";
        echo "  php bin/alexa <command> [options]\n\n";
        echo "Commands:\n";
        echo "  make:intent-handler <name> --intent=<intent>    Generate intent handler\n";
        echo "  make:launch-handler <name>                Generate launch handler\n";
        echo "  make:help-handler <name>                  Generate help handler\n";
        echo "  list                                      List available templates\n\n";
        echo "Options:\n";
        echo "  --name=<ClassName>                        Handler class name\n";
        echo "  --intent=<IntentName>                      Intent name (for intent handlers)\n\n";
        echo "Examples:\n";
        echo "  php bin/alexa make:intent-handler MyIntent --intent=MyIntent\n";
        echo "  php bin/alexa make:launch-handler LaunchHandler\n";
        echo "  php bin/alexa make:help-handler HelpHandler\n";
    }

    private function success(string $message): void
    {
        echo "\033[32m✓\033[0m {$message}\n";
    }

    private function error(string $message): void
    {
        echo "\033[31m✗\033[0m {$message}\n";
    }

    private function info(string $message): void
    {
        echo "\033[34mℹ\033[0m {$message}\n";
    }
}

// Create templates directory if it doesn't exist
$templatesDir = __DIR__ . '/../templates';
if (!is_dir($templatesDir)) {
    mkdir($templatesDir, 0755, true);
}

// Create template files if they don't exist
$intentTemplate = <<<PHP
<?php

declare(strict_types=1);

namespace App\Handlers;

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Request\Request;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * {{DESCRIPTION}}
 */
class {{CLASS_NAME}} extends AbstractRequestHandler
{
    public function supportsApplication(Request \$request): bool
    {
        return true; // Add your skill ID check here
    }

    public function supportsRequest(Request \$request): bool
    {
        return \$request->request instanceof \Rboschin\AmazonAlexa\Request\Request\Standard\IntentRequest &&
               \$request->request->intent->name === '{{INTENT_NAME}}';
    }

    public function handleRequest(Request \$request): \Rboschin\AmazonAlexa\Response\Response
    {
        \$slotValue = \$request->request->intent->slots['exampleSlot']->value ?? null;
        
        return ResponseBuilder::create()
            ->text("You triggered {{INTENT_NAME}} with slot value: {\$slotValue}")
            ->reprompt("What else would you like to do?")
            ->keepSession()
            ->build();
    }
}
PHP;

$launchTemplate = <<<PHP
<?php

declare(strict_types=1);

namespace App\Handlers;

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Request\Request;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * {{DESCRIPTION}}
 */
class {{CLASS_NAME}} extends AbstractRequestHandler
{
    public function supportsApplication(Request \$request): bool
    {
        return true; // Add your skill ID check here
    }

    public function supportsRequest(Request \$request): bool
    {
        return \$request->request instanceof \Rboschin\AmazonAlexa\Request\Request\Standard\LaunchRequest;
    }

    public function handleRequest(Request \$request): \Rboschin\AmazonAlexa\Response\Response
    {
        return ResponseBuilder::create()
            ->text('Welcome to the skill!')
            ->reprompt('How can I help you today?')
            ->keepSession()
            ->build();
    }
}
PHP;

$helpTemplate = <<<PHP
<?php

declare(strict_types=1);

namespace App\Handlers;

use Rboschin\AmazonAlexa\RequestHandler\AbstractRequestHandler;
use Rboschin\AmazonAlexa\Request\Request;
use Rboschin\AmazonAlexa\Response\ResponseBuilder;

/**
 * {{DESCRIPTION}}
 */
class {{CLASS_NAME}} extends AbstractRequestHandler
{
    public function supportsApplication(Request \$request): bool
    {
        return true; // Add your skill ID check here
    }

    public function supportsRequest(Request \$request): bool
    {
        return \$request->request instanceof \Rboschin\AmazonAlexa\Request\Request\Standard\IntentRequest &&
               in_array(\$request->request->intent->name, [
                   'AMAZON.HelpIntent',
                   'AMAZON.CancelIntent',
                   'AMAZON.StopIntent'
               ]);
    }

    public function handleRequest(Request \$request): \Rboschin\AmazonAlexa\Response\Response
    {
        \$intentName = \$request->request->intent->name;
        
        switch (\$intentName) {
            case 'AMAZON.HelpIntent':
                return ResponseBuilder::create()
                    ->text('You can ask me to do various things. What would you like to know?')
                    ->reprompt('How can I help you?')
                    ->keepSession()
                    ->build();
            
            case 'AMAZON.CancelIntent':
            case 'AMAZON.StopIntent':
                return ResponseBuilder::create()
                    ->text('Goodbye!')
                    ->endSession(true)
                    ->build();
            
            default:
                return ResponseBuilder::create()
                    ->text('I can help you with that. What would you like to do?')
                    ->reprompt('How can I assist you?')
                    ->keepSession()
                    ->build();
        }
    }
}
PHP;

file_put_contents($templatesDir . '/intent-handler.php.template', $intentTemplate);
file_put_contents($templatesDir . '/launch-handler.php.template', $launchTemplate);
file_put_contents($templatesDir . '/help-handler.php.template', $helpTemplate);

// Run the CLI
$cli = new AlexaCli();
$cli->run($argv);
?>
